# 管理 Azure 订阅和资源

# 实验室：探索 Azure 中的监控功能

### 方案

Adatum Corporation 希望浏览 Azure 中的监控功能

### 目标

完成本实验室后，你将能执行以下操作：

- 部署 Azure VM 规模集

- 使用 Azure Monitor 实施监控和警报

### 实验室设置

预计用时：45 分钟

用户名：**学生**

密码：**Pa55w.rd**

# 练习 1： 部署 Azure VM 规模集

本练习的主要任务如下：

1. 使用 Azure QuickStart 模板部署 Azure VM 规模集

1. 查看 Azure VM 规模集的自动缩放设置

#### 任务 1： 使用 Azure QuickStart 模板部署 Azure VM 规模集

1. 在实验室虚拟机中，启动 Microsoft Edge 并浏览位于 http://portal.azure.com 的 Azure 门户，然后使用在目标 Azure 订阅中具有所有者角色的 Microsoft 帐户登录。

1. 在 Azure 门户的 Microsoft Edge 窗口中，启动一个在 Cloud Shell 中的 **PowerShell** 会话。

1. 如果显示**你没有装载存储器**消息，单击**显示高级设置** 然后使用以下设置配置存储器：

   - 订阅：目标 Azure 订阅的名称

   - Cloud Shell 区域：订阅中可用的 Azure 区域的名称，该区域最接近实验室位置

   - 资源组：新资源组的名称 **“az3000100-LabRG”**

   - 存储帐户：新存储帐户的名称（3 到 24 个字符，由小写字母和数字组成）

   - 文件共享： 新文件共享的名称： **cloudshell**

1. 在 Cloud Shell 窗格中，运行以下命令以标识唯一的 DNS 域名（用任何以字母开头且不超过 9 个字符的字母数字字符串（很可能是唯一的）替换占位符 `<custom-label>`，并使用你希望在本实验室中部署资源的 Azure 区域名称替换占位符 `<location>`）：

   ```pwsh
   Test-AzDnsAvailability -DomainNameLabel <custom-label> -Location '<location>'
   ```

1. 验证命令是否返回了 **True**。如果没有，请使用不同的 `<custom-label>`  值重新运行相同的命令，直到命令返回为 **True** 为止。

1. 记下导致结果成功的 `<custom-label>` 值。你在下一个任务中将需要该结果。

1.  在实验室计算机上，在 Azure 门户中搜索并选择 **“模板部署（使用自定义模板进行部署）”**。

1.  在 **“自定义部署”** 边栏选项卡中，在 **“选择模板（免责声明）”** 下拉列表内，键入 **“201-vmss-bottle-autoscale”**，然后单击 **“选择模板”**。

1. 在 Azure 门户中，在 **“使用 Python Bottle 服务器和自动缩放部署 VM 规模集”** 边栏选项卡，指定以下设置并启动部署：

   - 订阅：目标 Azure 订阅的名称

   - 资源组：新资源组的名称 **az3000101-LabRG **

   - 位置：在此任务前期运行 `Test-AzDnsAvailability` 时引用的 Azure 区域的名称

   - VM SKU： **Standard_D2s_v3**

   - Vmss 名称：在此任务前期运行 `Test-AzDnsAvailability` 时标识的自定义标签

   - 实例数：**1**

   - 管理员用户名：**学生**
   
   - 验证类型：**密码**

   - 管理员密码：**Pa55w.rd1234**

1. 勾选**我同意上述条款和条件**旁边的复选框 ，然后单击**购买**。

1. 等待部署完成。该操作将需要约 5 分钟。

#### 任务 2：查看 Azure VM 规模集的自动缩放设置

1. 在 Azure 门户中，导航到表示新部署的 **“Azure VM 规模集”** 的边栏选项卡。

1. 从VM 规模集边栏选项卡导航到它的**缩放**边栏选项卡。

1. 请注意，Azure VM 规模集配置为基于使用以下条件的指标进行动态缩放：

   - 扩大：当 CPU 的平均百分比 > 40 时，将实例数增加 1

   - 缩小：当 CPU 的平均百分比 < 20 时，将实例数减少 1

   - 最小实例数：1

   - 最大实例数：10

1. 将最大实例数修改为 3 并**保存**更改。

> **结果**：完成本练习后，你即已部署 Azure VM 规模集并查看其自动缩放设置。

## 练习 2： 使用 Azure Monitor 实现监控和警报

本练习的主要任务如下：

1. 创建 Azure VM 规模集基于指标的警报

1. 配置 Azure VM 规模集基于自动缩放的通知

1. 测试 Azure VM 规模集的监控和警报。

#### 任务 1：创建 Azure VM 规模集基于指标的警报

1. 在 Azure 门户中，导航到表示新部署的 Azure VM 规模集的边栏选项卡，然后从中切换到**监控 - 指标**边栏选项卡。

1. 在**监控 - 指标**边栏选项卡，使用筛选器显示 **CPU 百分比**指标，为你在本实验的上一个练习中预配的VM规模集资源**平均值**的聚合值。。

1. 查看生成的图表，并记下最近几分钟内 CPU 的平均百分比。

1. 导航到在**监控**部分的**警报**边栏选项卡。

1. 从**警报** 边栏选项卡导航到**管理操作**边栏选项卡。

1. 在**管理操作**部分，单击**添加操作组**，将操作组名称设置为 **az30001 操作组**，设置简称：**az30001**，选择你在上一个练习中使用的 Azure 订阅，接受 **Default-ActivityLogAlerts（要创建**资源组的默认名称，设置操作名称 **az30001-电子邮件**，并将操作类型设置为**电子邮件/短信/推送/语音**。 

1. 在**电子邮件/短信/推送/语音**边栏选项卡上，设置你要用于接收此规则生成的警报的电子邮件地址、手机号码或电话号码。

1. 在“添加操作组”页面上，单击**是**。

1. 导航到**警报**边栏选项卡。

1. 从**警报**边栏选项卡导航到**新警报规则**边栏选项卡。

1. 在**资源**部分中，选择你在本实验室的上一个练习中配置的VM规模集。

1. 在 **“条件”** 部分，单击 **“添加条件”**，选择 **“CPU 百分比”** 指标，保留维度设置和条件类型的默认值，将条件设置为 **“大于”**，将类型聚合设置为 **“平均值”**，将阈值设置为 **“40”**，将聚合粒度（时长）设置为 **“1 分钟”**，将频率设置为 **“每 1 分钟一次”**，然后单击 **“完成”**。

1. 在 **“操作”** 部分，单击 **“选择操作组”**，选择先前创建的操作组 **“az30001 操作组”**，然后单击 **“完成”**。

1. 在 **“警报详细信息”** 部分中，将警报规则名称设置为 **“VM 规模集的 CPU 百分比大于 60％”**，将其说明设置为 **“VM 规模集的 CPU 百分比大于 60％”**，将其严重性设置为 **“Sev 3”**，并将“创建时启用规则”设置为 **“是”**。

1. 单击**创捷警报规则**。

   > **注意**：指标警报规则最多可能需要 10 分钟才能生效。 

#### 任务 2： 配置 Azure VM 规模集基于自动缩放的通知

1. 在 Azure 门户中，导航到表示新部署的 Azure VM 规模集的边栏选项卡，然后从中切换到**缩放**边栏选项卡。

1. 在**缩放** 边栏选项卡，单击**通知** 选项卡标题，配置以下设置，并**保存**变更：

   - 电子邮件管理员：已启用

   - 电子邮件共同管理员：已禁用

   - 其他管理员电子邮件：添加你要用于接收有关自动缩放事件通知的电子邮件地址

#### 任务 3：测试 Azure VM 规模集的监控和警报。

1. 在 Azure 门户中，搜索**负载均衡器**并导航到负载均衡器边栏选项卡。应该存在一个负载均衡器，表示使用你在本实验室的上一个练习中从模板部署的规模集创建的负载均衡器。

1. 确定分配给与 VM 规模集关联的负载均衡器前端的**公共 IP 地址**值。

1. 在实验室计算机中启动 Microsoft Edge，并浏览到 http://_Public IP address:9000**_**（其中，**_Public IP address_** 是在上一步中识别的 IP 地址）

1. 在**工作程序界面**页面，单击**开始工作**链接。

1. 使用 VM 规模集概述边栏选项卡上的** CPU（平均值）**图表，用于监控 CPU 利用率的变化。

   > **注意**：或者，你可以导航回到**指标**边栏选项卡并使用筛选器显示VM 规模集资源的**CPU 百分比**指标，并设置时间为**最近 30 分钟**。

   > **注意**：你应该会在几分钟内收到有关 CPU 利用率增加的警报

1. 切换到 VM 规模集的 **“实例”** 边栏选项卡以确定其实例数。

   > **注意**：或者，你可以导航回到 **“缩放”** 边栏选项卡，在能够自动缩放的资源列表中，单击 VM 规模集的名称，在 **“自动缩放设置”** 边栏选项卡上，单击 **“运行历史记录”**，然后查看自动缩放事件列表。

   > **注意**：应在几分钟内触发自动缩放。

1. 切换到显示工作程序实例页面的 Microsoft Edge 窗口，然后单击**停止工作**链接。

1. 使用在扩大 VM 规模集时所使用的相同方法监视 CPU 使用率的降低和缩放事件。

> **结果**：完成此练习后，你已使用 Azure Monitor 实现并测试了监控和警报。

## 练习 3：删除实验室资源

本练习的主要任务如下：

1. 发现在本实验室中创建的资源组

1. 删除在本实验室中创建的资源组

### 任务 1：发现在本实验室中创建的资源组

1. 在门户顶部，单击 **“Cloud Shell”** 图标以打开“Cloud Shell”窗格，并根据需要切换到 **PowerShell**。

1. 在 **“Cloud Shell”** 命令提示符处，键入以下命令并按 **Enter** 键列出你在本实验室中创建的所有资源组：

   ```pwsh
   Get-AzResourceGroup -Name 'az300010*'
   ```

1. 验证输出中是否仅包含你在本实验室中创建的资源组。这些组将在下一个任务中删除。

#### 任务 2：删除在本实验室中创建的资源组

1. 在 **“Cloud Shell”** 命令提示符处，键入以下命令并按 **Enter** 键以删除你在本实验室中创建的资源组

   ```pwsh
   Get-AzResourceGroup -Name 'az300010*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**注意**：该命令异步执行（由 -AsJob 参数确定），因此尽管此后可以立即在同一 PowerShell 会话中运行另一个 PowerShell 命令，但实际上要花几分钟才能删除资源组。
    
1. 关闭门户底部的 **Cloud Shell** 提示。

> **结果**：完成本练习后，你即删除了本实验室中使用的资源。
